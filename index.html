<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centelha - Assistente Virtual | Oficina FG Motos</title>
    
    <!-- Tailwind CSS para um design moderno e responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts para uma tipografia mais agrad√°vel -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Estiliza√ß√£o base e customiza√ß√µes */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Fundo cinza claro e limpo */
        }

        /* Estiliza√ß√£o da barra de rolagem para um visual mais limpo */
        #chat-window::-webkit-scrollbar {
            width: 6px;
        }
        #chat-window::-webkit-scrollbar-track {
            background: #e5e7eb;
        }
        #chat-window::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 10px;
        }
        #chat-window::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* Anima√ß√£o para o indicador de "digitando..." */
        .typing-indicator span {
            height: 8px;
            width: 8px;
            float: left;
            margin: 0 1px;
            background-color: #9E9EA1;
            display: block;
            border-radius: 50%;
            opacity: 0.4;
            animation: bob 1s infinite;
        }
        .typing-indicator span:nth-of-type(2) {
            animation-delay: 0.2s;
        }
        .typing-indicator span:nth-of-type(3) {
            animation-delay: 0.4s;
        }
        @keyframes bob {
            10% { transform: translateY(-5px); background-color: #777; }
            50% { transform: translateY(0); background-color: #9E9EA1; }
        }
    </style>
</head>
<body class="flex items-center justify-center h-screen p-4 bg-gray-200">

    <!-- Container do Chat -->
    <div id="chat-container" class="w-full max-w-lg h-full sm:h-[90vh] sm:max-h-[700px] bg-white rounded-2xl shadow-2xl flex flex-col overflow-hidden">
        
        <!-- Cabe√ßalho do Chat -->
        <div id="chat-header" class="bg-gray-800 p-4 flex items-center justify-between gap-4 shadow-md z-10">
            <div class="flex items-center gap-4">
                <!-- √çcone da Centelha -->
                <div class="w-14 h-14 bg-yellow-500 rounded-full flex items-center justify-center shadow-lg">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                     </svg>
                </div>
                <div>
                    <h2 class="text-white text-lg font-bold">Centelha, sua assistente ‚ö°</h2>
                    <span class="text-yellow-400 text-sm">Oficina FG Motos ‚Ä¢ Online</span>
                </div>
            </div>
        </div>

        <!-- Janela de Mensagens -->
        <div id="chat-window" class="flex-1 p-4 sm:p-6 overflow-y-auto bg-gray-50">
            <div id="chat-messages" class="flex flex-col gap-4">
                <!-- As mensagens do chat ser√£o inseridas aqui via JavaScript -->
            </div>
        </div>

        <!-- √Årea de Input -->
        <div id="chat-input-container" class="p-4 bg-white border-t border-gray-200">
            <div class="flex items-center bg-gray-100 rounded-full px-2">
                <input type="text" id="chat-input" placeholder="Digite sua resposta..." class="flex-1 bg-transparent p-3 text-gray-700 placeholder-gray-500 focus:outline-none">
                <button id="send-btn" class="p-3 rounded-full bg-yellow-500 hover:bg-yellow-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- CORRE√á√ÉO DE SEGURAN√áA ---
        // A sua chave de API NUNCA deve ser exposta no c√≥digo do lado do cliente (HTML, JS).
        // Deixando a string vazia, o ambiente de execu√ß√£o se encarrega de adicion√°-la de forma segura.
        const API_KEY = ""; 

        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const chatMessages = document.getElementById('chat-messages');
        const chatWindow = document.getElementById('chat-window');

        // Vari√°veis para controlar o fluxo da conversa e armazenar dados
        let conversationState = 'ASKING_NAME';
        let customerData = {
            name: '',
            moto: '',
            problem: ''
        };

        // C√©rebro da Centelha: Instru√ß√µes para a IA
        const systemPrompt = `
        Voce e a Centelha, a assistente virtual da "Oficina FG Motos". Sua personalidade e amigavel, confiavel e prestativa.
        Seu objetivo e dar um diagnostico preliminar baseado no problema da moto do cliente.
        NUNCA use formatacao markdown, como asteriscos ou hashtags. Mantenha o texto limpo e direto.
        
        CLIENTE: {CLIENT_NAME}
        MOTO: {MOTO_MODEL}
        PROBLEMA: {MOTO_PROBLEM}

        Baseado no problema descrito, forneca uma lista com 2 ou 3 causas mais comuns.
        Apos o diagnostico, inclua este aviso OBRIGATORIO: "Lembre-se que e so uma dica inicial, ta bom? Para um diagnostico preciso e seguro, o ideal e trazer sua moto para nossos mecanicos avaliarem."
        `;
        
        // Fun√ß√£o para remover o indicador de "digitando"
        function removeTypingIndicator() {
            const typingIndicator = document.querySelector('.typing-indicator')?.closest('.w-full');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Fun√ß√£o para adicionar mensagens ao chat com visual aprimorado
        function addMessage(sender, text) {
            const messageContainer = document.createElement('div');
            messageContainer.className = `w-full flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            
            let messageHTML = '';
            
            if (sender === 'assistant' && text === 'typing') {
                messageHTML = `<div class="bg-gray-200 text-gray-800 p-3 rounded-2xl rounded-br-lg max-w-sm"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`;
            } else {
                const cleanText = text.replace(/\*/g, ""); // Remove asteriscos por seguran√ßa
                const buttonRegex = /\[BUTTON:(.+?)\|(.+?)\]/g;
                // Converte a tag de bot√£o em um link HTML real
                const textWithButtons = cleanText.replace(buttonRegex, (match, buttonText, url) => {
                    return `<a href="${url}" target="_blank" class="chat-button block text-center mt-3 bg-yellow-500 text-white font-bold py-2 px-4 rounded-full hover:bg-yellow-600 transition-colors duration-200 no-underline">${buttonText}</a>`;
                });

                // --- MELHORIA VISUAL ---
                // Mensagem do usu√°rio com fundo amarelo e canto arredondado inferior esquerdo
                // Mensagem do assistente com fundo cinza e canto arredondado inferior direito
                messageHTML = sender === 'user' 
                    ? `<div class="bg-yellow-500 text-white p-3 rounded-2xl rounded-br-lg max-w-md shadow"><p>${textWithButtons}</p></div>`
                    : `<div class="bg-gray-200 text-gray-800 p-3 rounded-2xl rounded-bl-lg max-w-md shadow"><p>${textWithButtons}</p></div>`;
            }
            
            messageContainer.innerHTML = messageHTML;
            chatMessages.appendChild(messageContainer);
            chatWindow.scrollTop = chatWindow.scrollHeight; // Rola para a mensagem mais recente
            return messageContainer;
        }

        // Gera o link final para o WhatsApp com todos os dados
        function generateWhatsAppLink() {
            const introText = "Ol√°! Vim atrav√©s da assistente Centelha.";
            // Formata√ß√£o para o WhatsApp com quebras de linha
            const summary = `\n\n*Resumo do Atendimento:*\n- *Cliente:* ${customerData.name}\n- *Moto:* ${customerData.moto}\n- *Problema:* ${customerData.problem}`;
            const fullText = introText + summary;
            const encodedText = encodeURIComponent(fullText);
            const whatsappUrl = `https://wa.me/5567999271603?text=${encodedText}`;
            
            // Mensagem que inclui um bot√£o para abrir o WhatsApp
            const transferMessage = `Obrigado pelas informa√ß√µes! Para agilizar seu atendimento com nossa equipe, preparei um resumo da nossa conversa. √â s√≥ clicar no bot√£o abaixo e enviar a mensagem que j√° vai aparecer pronta no seu WhatsApp. [BUTTON:Falar com a Equipe|${whatsappUrl}]`;
            
            addMessage('assistant', transferMessage);
        }
        
        // Fun√ß√£o gen√©rica para chamar a API da Gemini
        async function callGeminiAPI(prompt, maxTokens = 150) {
             const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    maxOutputTokens: maxTokens,
                    temperature: 0.7,
                }
            };
            
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API call failed with status: ${response.status}`);
            }

            return response.json();
        }

        // Pede o diagn√≥stico para a IA de forma segura
        async function getDiagnosis() {
            addMessage('assistant', 'typing');
            
            const finalPrompt = systemPrompt
                .replace('{CLIENT_NAME}', customerData.name)
                .replace('{MOTO_MODEL}', customerData.moto)
                .replace('{MOTO_PROBLEM}', customerData.problem);

            try {
                const data = await callGeminiAPI(finalPrompt, 200); // Aumenta um pouco os tokens para o diagn√≥stico
                
                // --- CORRE√á√ÉO DE ROBUSTEZ ---
                // Verifica se a resposta da API tem a estrutura esperada antes de us√°-la
                if (data.candidates && data.candidates.length > 0 && data.candidates[0].content.parts.length > 0) {
                    const diagnosisText = data.candidates[0].content.parts[0].text.trim();
                    removeTypingIndicator();
                    addMessage('assistant', diagnosisText);
                    setTimeout(generateWhatsAppLink, 1000); // Adiciona um delay antes de mostrar o bot√£o
                } else {
                    throw new Error('Resposta da API inv√°lida ou vazia.');
                }

            } catch (error) {
                console.error("Diagnosis Error:", error);
                removeTypingIndicator();
                addMessage('assistant', 'N√£o consegui gerar um diagn√≥stico. Mas n√£o se preocupe, vamos pular direto para o atendimento com nossa equipe.');
                generateWhatsAppLink();
            }
        }

        // Valida se a entrada √© um nome usando a IA
        async function isValidName(name) {
            if (name.split(' ').length > 5 || /\d/.test(name)) return false; // Filtro r√°pido inicial

            const validationPrompt = `A frase a seguir √© um nome pr√≥prio de uma pessoa ou um apelido comum? Responda apenas "SIM" ou "NAO". Frase: "${name}"`;
            try {
                const data = await callGeminiAPI(validationPrompt, 5); // Poucos tokens, resposta r√°pida
                if (data.candidates && data.candidates[0]?.content?.parts[0]?.text) {
                    const AIText = data.candidates[0].content.parts[0].text.trim().toUpperCase();
                    return AIText.includes('SIM');
                }
                return false; // Se a resposta for malformada, assume que n√£o √© um nome
            } catch (error) {
                console.error("Name validation failed:", error);
                // Em caso de falha na API, usa uma l√≥gica simples para n√£o bloquear o usu√°rio
                return true; 
            }
        }
        
        // Valida se a entrada √© um modelo de moto usando a IA
        async function isValidMoto(moto) {
            const validationPrompt = `O texto a seguir descreve uma marca e modelo de motocicleta que existe (Ex: Honda CB 300, Yamaha Fazer 250)? Responda apenas "SIM" ou "NAO". Texto: "${moto}"`;
            try {
                const data = await callGeminiAPI(validationPrompt, 5);
                if (data.candidates && data.candidates[0]?.content?.parts[0]?.text) {
                    const AIText = data.candidates[0].content.parts[0].text.trim().toUpperCase();
                    return AIText.includes('SIM');
                }
                return false;
            } catch (error) {
                console.error("Moto validation failed:", error);
                return true; // Em caso de erro na API, assume que √© v√°lido para n√£o bloquear o usu√°rio.
            }
        }

        // Lida com perguntas gerais (endere√ßo, etc.)
        function handleGeneralQuestions(userInput) {
            const lowerCaseInput = userInput.toLowerCase();
            const addressKeywords = ['endere√ßo', 'onde fica', 'localiza√ß√£o', 'local', 'rua'];
            
            if (addressKeywords.some(keyword => lowerCaseInput.includes(keyword))) {
                const addressMessage = `Claro! Nosso endere√ßo √© Av. Fabio Zahran, 6628, Vila Carvalho, em Campo Grande-MS. Se quiser, pode ver no mapa! [BUTTON:Ver no Mapa|https://www.google.com/maps/search/?api=1&query=Av.+Fabio+Zahran,+6628,+Vila+Carvalho,+Campo+Grande-MS]`;
                addMessage('assistant', addressMessage);
                
                // Re-pergunta o que era esperado no estado atual da conversa
                setTimeout(() => {
                    let followupMessage = '';
                    switch (conversationState) {
                        case 'ASKING_NAME':
                            followupMessage = 'Agora que j√° sabe onde estamos, pode me dizer o seu nome?';
                            break;
                        case 'ASKING_MOTO':
                            followupMessage = `Certo, ${customerData.name}. De volta ao assunto, qual a marca e o modelo da sua moto?`;
                            break;
                        case 'ASKING_PROBLEM':
                            followupMessage = `Ok, ${customerData.name}! E sobre a sua ${customerData.moto}, qual o problema que ela est√° apresentando?`;
                            break;
                    }
                    if(followupMessage) addMessage('assistant', followupMessage);
                }, 1500);

                return true; // Indica que a pergunta foi tratada
            }
            return false; // Indica que n√£o √© uma pergunta geral
        }

        // Fun√ß√£o principal que controla o fluxo da conversa
        async function handleConversation(userInput) {
            if (handleGeneralQuestions(userInput)) {
                return; // Se foi uma pergunta sobre endere√ßo, para a execu√ß√£o aqui.
            }
            
            switch (conversationState) {
                case 'ASKING_NAME':
                    addMessage('assistant', 'typing');
                    const isName = await isValidName(userInput);
                    removeTypingIndicator();

                    if (isName) {
                        customerData.name = userInput.trim();
                        conversationState = 'ASKING_MOTO';
                        addMessage('assistant', `Prazer, ${customerData.name}! Agora, por favor, me diga a marca e o modelo da sua moto. (Ex: Honda Biz 125, Yamaha Fazer 250)`);
                    } else {
                        addMessage('assistant', 'Desculpe, n√£o entendi isso como um nome. Para um atendimento mais pessoal, voc√™ poderia me informar apenas o seu nome, por favor? üòä');
                    }
                    break;
                case 'ASKING_MOTO':
                    addMessage('assistant', 'typing');
                    const isMoto = await isValidMoto(userInput);
                    removeTypingIndicator();

                    if (isMoto) {
                        customerData.moto = userInput.trim();
                        conversationState = 'ASKING_PROBLEM';
                        addMessage('assistant', `Entendido, uma ${customerData.moto}. E qual o problema que ela est√° apresentando? Descreva com detalhes para eu tentar ajudar.`);
                    } else {
                        addMessage('assistant', 'N√£o reconheci isso como um modelo de moto. Por favor, tente informar a marca e o modelo novamente, como "Honda Biz" ou "Yamaha Fazer".');
                    }
                    break;
                case 'ASKING_PROBLEM':
                    customerData.problem = userInput.trim();
                    conversationState = 'CONVERSATION_DONE';
                    chatInput.disabled = true;
                    sendBtn.disabled = true;
                    chatInput.placeholder = "Conversa finalizada.";
                    addMessage('assistant', 'Ok, entendi. Estou analisando o problema...');
                    getDiagnosis(); // Inicia o diagn√≥stico final
                    break;
            }
        }

        // Fun√ß√£o de envio de mensagem
        async function handleSend() {
            const userInput = chatInput.value.trim();
            if (userInput === '' || chatInput.disabled) return;

            addMessage('user', userInput);
            chatInput.value = '';
            
            await handleConversation(userInput);
        }

        // Event Listeners para o bot√£o e a tecla Enter
        sendBtn.addEventListener('click', handleSend);
        chatInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                handleSend();
            }
        });
        
        // Mensagem de boas-vindas inicial quando a p√°gina carrega
        window.onload = () => {
             setTimeout(() => {
                addMessage('assistant', "Ol√°! Sou a Centelha, assistente virtual da Oficina FG Motos. Para come√ßarmos, qual o seu nome?");
            }, 500);
        };

    </script>
</body>
</html>
